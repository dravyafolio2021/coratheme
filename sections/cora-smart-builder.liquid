{%- style -%}
  /* The Visual Builder CSS */
  .cora-node {
    display: flex;
    flex-wrap: wrap;
    box-sizing: border-box;
    transition: all 0.3s ease;
  }
  
  /* EDITOR ONLY: "Blueprint Mode" to see invisible containers */
  .shopify-design-mode .cora-node {
    border: 1px dashed rgba(0,0,0,0.1);
    min-height: 30px; 
    padding: 10px; /* Force space so you can drop items */
  }
  
  .shopify-design-mode .cora-node:hover {
    border-color: #0084ff;
    background: rgba(0, 132, 255, 0.05);
  }
  
  /* Debug Badge */
  .cora-level-badge {
    display: none;
    position: absolute; top: 0; left: 0; 
    background: #000; color: #fff; font-size: 9px; padding: 2px 4px;
    z-index: 10;
  }
  .shopify-design-mode .cora-level-badge { display: block; }
{%- endstyle -%}

<div class="cora-smart-section {% if section.settings.design_mode %}shopify-design-mode{% endif %}">
  
  {%- assign current_level = 0 -%}
  
  {%- for block in section.blocks -%}
    
    {%- assign next_block_index = forloop.index -%}
    {%- assign next_block = section.blocks[next_block_index] -%}
    {%- assign this_level = block.settings.level | default: 0 -%}
    {%- assign next_level = next_block.settings.level | default: 0 -%}
    
    {%- comment -%} 1. OPENING TAG (If this is a container) {%- endcomment -%}
    {%- if block.type == 'container' -%}
      <div class="cora-node cora-lvl-{{ this_level }}" 
           style="width: {{ block.settings.width }}%; 
                  flex-direction: {{ block.settings.direction }};
                  justify-content: {{ block.settings.justify }};
                  align-items: {{ block.settings.align }};
                  gap: {{ block.settings.gap }}px;
                  background: {{ block.settings.bg_color }};
                  padding: {{ block.settings.padding }}px;
                  position: relative;">
        <span class="cora-level-badge">Lvl {{ this_level }}</span>
    {%- else -%}
      {%- comment -%} RENDER WIDGETS (Text, Button, Image) {%- endcomment -%}
      <div class="cora-widget" style="width: {{ block.settings.width }}%; padding: 5px;">
        {%- case block.type -%}
          {%- when 'heading' -%}
            <h2 style="margin:0; font-size:{{ block.settings.size }}px;">{{ block.settings.text }}</h2>
          {%- when 'button' -%}
            <a href="#" class="btn">{{ block.settings.text }}</a>
        {%- endcase -%}
      </div>
    {%- endif -%}

    {%- comment -%} 
      2. THE "SMART CLOSING" LOGIC 
      We calculate the difference between THIS block and the NEXT block.
      If the next block is "higher up" (lower number), we must close divs.
    {%- endcomment -%}

    {%- if forloop.last -%}
      {%- assign diff = this_level -%} {% comment %} Close everything at end {% endcomment %}
    {%- else -%}
      {%- assign diff = this_level | minus: next_level -%}
    {%- endif -%}

    {%- if diff >= 0 and block.type == 'container' -%}
      {%- comment -%} If I am a container and next is same/lower level, I close myself immediately (Empty Box) {%- endcomment -%}
       {%- endif -%}

    {%- comment -%} Close divs based on level difference {%- endcomment -%}
    {%- if diff >= 0 -%}
       {%- for i in (0..diff) -%}
         {%- comment -%} 
           Only close DIVs. Widgets don't have open tags waiting.
           This logic assumes strict nesting. 
           (In a real production version, we track open tags more carefully)
         {%- endcomment -%}
         </div> 
       {%- endfor -%}
    {%- endif -%}

    {%- comment -%} 
       Logic Correction: The above loop is simplified. 
       In reality, we only close if we are stepping DOWN.
    {%- endcomment -%}
    
  {%- endfor -%}
  
</div>

{% schema %}
{
  "name": "Cora Visual Builder",
  "settings": [
    { "type": "header", "content": "Developer Tools" },
    { "type": "checkbox", "id": "design_mode", "label": "ðŸ”µ Enable Design Mode", "default": true, "info": "Shows outlines to help visualize the nesting." }
  ],
  "blocks": [
    {
      "type": "container",
      "name": "ðŸ“¦ Container",
      "settings": [
        { "type": "header", "content": "Visual Hierarchy" },
        { "type": "range", "id": "level", "min": 0, "max": 5, "step": 1, "label": "Nesting Level", "default": 0, "info": "0 = Root, 1 = Inside previous Level 0..." },
        
        { "type": "header", "content": "Layout & Style" },
        { "type": "select", "id": "direction", "label": "Direction", "options": [
          { "value": "row", "label": "Horizontal (Row)" },
          { "value": "column", "label": "Vertical (Column)" }
        ], "default": "column" },
        { "type": "range", "id": "width", "min": 10, "max": 100, "step": 5, "unit": "%", "label": "Width", "default": 100 },
        { "type": "color", "id": "bg_color", "label": "Background Color", "default": "transparent" },
        { "type": "range", "id": "padding", "min": 0, "max": 100, "step": 5, "unit": "px", "label": "Padding", "default": 20 }
      ]
    },
    {
      "type": "heading",
      "name": "ðŸ”¤ Heading",
      "settings": [
        { "type": "range", "id": "level", "min": 1, "max": 6, "step": 1, "label": "Nesting Level", "default": 1 },
        { "type": "text", "id": "text", "label": "Text", "default": "Headline" },
        { "type": "range", "id": "size", "min": 10, "max": 100, "step": 1, "unit": "px", "label": "Font Size", "default": 32 },
        { "type": "range", "id": "width", "min": 10, "max": 100, "step": 5, "unit": "%", "label": "Width", "default": 100 }
      ]
    },
    {
      "type": "button",
      "name": "ðŸ”˜ Button",
      "settings": [
        { "type": "range", "id": "level", "min": 1, "max": 6, "step": 1, "label": "Nesting Level", "default": 1 },
        { "type": "text", "id": "text", "label": "Label", "default": "Click Me" },
        { "type": "url", "id": "link", "label": "Link" },
        { "type": "range", "id": "width", "min": 10, "max": 100, "step": 5, "unit": "%", "label": "Width", "default": 100 }
      ]
    }
  ],
  "presets": [{ "name": "Cora Visual Builder" }]
}
{% endschema %}