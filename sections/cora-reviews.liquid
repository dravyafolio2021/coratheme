{% comment %}
  ✅ Cora Reviews (Zenmies)
  Final version — Fully valid Shopify schema, responsive design, gallery as image blocks, and no invalid types.
{% endcomment %}

<section id="cora-reviews-{{ section.id }}" class="cora-reviews">
  <div class="cora-reviews__inner container">
    {% if section.settings.heading != blank %}
      <h2 class="cora-reviews__heading" style="color: {{ section.settings.heading_color }};">
        {{ section.settings.heading }}
      </h2>
    {% endif %}

    <!-- Ratings Summary Section -->
    <div class="cora-reviews__summary">
      <!-- Left: Overall Score -->
      <div class="cora-reviews__left">
        <div class="cora-reviews__score">
          <span class="cora-reviews__rating-value">{{ section.settings.avg_rating }}</span>
          <div class="cora-reviews__stars" style="--star-color: {{ section.settings.star_color }};">
            {% assign avg_rating_num = section.settings.avg_rating | plus: 0 %}
            {% for i in (1..5) %}
              {% if i <= avg_rating_num %}
                ★
              {% else %}
                ☆
              {% endif %}
            {% endfor %}
          </div>
          <span class="cora-reviews__count">{{ section.settings.total_reviews }} reviews</span>
        </div>
      </div>

      <!-- Center: Rating Distribution Bars -->
      <div class="cora-reviews__center">
        {% assign total = section.settings.total_reviews | plus: 0 %}
        {% for n in (5..1) %}
          {% assign key = 'rating_' | append: n %}
          {% assign count = section.settings[key] | plus: 0 %}
          {% if total > 0 %}
            {% assign percent = count | times: 100 | divided_by: total %}
          {% else %}
            {% assign percent = 0 %}
          {% endif %}
          <div class="rating-bar">
            <span class="rating-label">{{ n }}</span>
            <div class="rating-bar__track">
              <div
                class="rating-bar__fill"
                style="width: {{ percent }}%; background: {{ section.settings.star_color }};"
              ></div>
            </div>
            <span class="rating-bar__count">{{ count }}</span>
          </div>
        {% endfor %}
      </div>

      <!-- Right: Write Review CTA -->
      <div class="cora-reviews__right">
        <p>Share your experience</p>
        <div class="cora-reviews__stars small">★★★★★</div>
        {% if section.settings.cta_label != blank %}
          <a href="{{ section.settings.cta_url | default: '#' }}" class="cora-reviews__button">
            {{ section.settings.cta_label }}
          </a>
        {% endif %}
      </div>
    </div>

    <!-- Gallery (as blocks) -->
    {% assign gallery_blocks = section.blocks | where: 'type', 'gallery_image' %}
    {% if gallery_blocks.size > 0 %}
      <div class="cora-reviews__gallery">
        {% for block in gallery_blocks %}
          {% if block.settings.image != blank %}
            <img src="{{ block.settings.image | image_url: width: 300 }}" alt="Customer photo" loading="lazy">
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    <!-- Review List -->
    <div class="cora-reviews__list">
      {% for block in section.blocks %}
        {% if block.type == 'review' %}
          <div class="cora-review__item">
            <div class="cora-review__header">
              <div class="cora-review__avatar">
                <div class="avatar-initial">{{ block.settings.name | slice: 0, 1 }}</div>
              </div>
              <div class="cora-review__info">
                <p class="cora-review__name">
                  {{ block.settings.name }}
                  {% if block.settings.verified %}
                    <span class="verified">✔ Verified Buyer</span>
                  {% endif %}
                </p>
                <div class="cora-review__stars" style="--star-color: {{ section.settings.star_color }};">
                  {% assign rating_num = block.settings.rating | plus: 0 %}
                  {% for i in (1..5) %}
                    {% if i <= rating_num %}
                      ★
                    {% else %}
                      ☆
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
              <span class="cora-review__date">{{ block.settings.date }}</span>
            </div>

            <p class="cora-review__text">{{ block.settings.review }}</p>

            {% if block.settings.recommend %}
              <p class="cora-review__recommend">❤️ Would recommend</p>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    </div>

    {% if section.settings.show_cta_button %}
      <div class="cora-reviews__more">
        <a href="{{ section.settings.more_url | default: '#' }}" class="cora-reviews__more-btn">
          {{ section.settings.more_label }}
        </a>
      </div>
    {% endif %}
  </div>
</section>

{{ 'cora-reviews.css' | asset_url | stylesheet_tag }}

{% schema %}
{
  "name": "Cora Reviews",
  "class": "cora-section cora-reviews",
  "settings": [
    { "type": "text", "id": "heading", "label": "Section Heading", "default": "Customer Reviews" },
    { "type": "color", "id": "heading_color", "label": "Heading Color", "default": "#160E26" },
    { "type": "text", "id": "avg_rating", "label": "Average Rating", "default": "4.8" },
    { "type": "text", "id": "total_reviews", "label": "Total Reviews", "default": "817" },
    { "type": "color", "id": "star_color", "label": "Star Color", "default": "#6B45E6" },
    { "type": "text", "id": "cta_label", "label": "CTA Label", "default": "WRITE A REVIEW" },
    { "type": "url", "id": "cta_url", "label": "CTA URL" },
    { "type": "checkbox", "id": "show_cta_button", "label": "Show 'See More Reviews' Button", "default": true },
    { "type": "text", "id": "more_label", "label": "See More Button Label", "default": "SEE MORE REVIEWS" },
    { "type": "url", "id": "more_url", "label": "See More Button URL" },
    { "type": "number", "id": "rating_5", "label": "5-Star Reviews", "default": 2967 },
    { "type": "number", "id": "rating_4", "label": "4-Star Reviews", "default": 706 },
    { "type": "number", "id": "rating_3", "label": "3-Star Reviews", "default": 67 },
    { "type": "number", "id": "rating_2", "label": "2-Star Reviews", "default": 173 },
    { "type": "number", "id": "rating_1", "label": "1-Star Reviews", "default": 0 }
  ],
  "blocks": [
    {
      "type": "gallery_image",
      "name": "Gallery Image",
      "settings": [{ "type": "image_picker", "id": "image", "label": "Upload Gallery Image" }]
    },
    {
      "type": "review",
      "name": "Review Item",
      "settings": [
        { "type": "text", "id": "name", "label": "Reviewer Name", "default": "Zarc. C" },
        { "type": "range", "id": "rating", "label": "Rating", "min": 1, "max": 5, "default": 5 },
        { "type": "text", "id": "date", "label": "Date", "default": "4 Months ago" },
        {
          "type": "textarea",
          "id": "review",
          "label": "Review Text",
          "default": "Didn’t feel much for the first couple of weeks but noticed subtle changes around day 18. Takes patience!"
        },
        { "type": "checkbox", "id": "verified", "label": "Verified Buyer", "default": true },
        { "type": "checkbox", "id": "recommend", "label": "Show 'Would recommend'", "default": true }
      ]
    }
  ],
  "presets": [{ "name": "Cora Reviews", "category": "Zenmies" }]
}
{% endschema %}
