{%- style -%}
  /* --- CORA BUILDER CSS --- */
  .cora-section-wrapper {
    width: 100%;
    overflow: hidden;
  }

  .cora-container {
    display: flex;
    box-sizing: border-box;
    position: relative;
    transition: all 0.2s ease-in-out;
  }

  /* EDITOR MODE: Blueprint Guides */
  .shopify-design-mode .cora-container {
    border: 1px dashed #bbb;
    min-height: 40px; /* Make empty containers visible */
  }
  .shopify-design-mode .cora-container:hover {
    border-color: #0084ff;
    box-shadow: inset 0 0 0 1px #0084ff;
  }
  .shopify-design-mode .cora-level-tag {
    position: absolute; top: 0; left: 0;
    background: #0084ff; color: white;
    font-size: 9px; padding: 1px 4px;
    z-index: 2; pointer-events: none;
  }

  /* RESPONSIVE: Mobile defaults */
  @media screen and (max-width: 768px) {
    .cora-mobile-col { flex-direction: column !important; }
    .cora-mobile-row { flex-direction: row !important; }
    .cora-mobile-w-100 { width: 100% !important; }
    .cora-mobile-pad-20 { padding: 20px !important; }
  }
{%- endstyle -%}

<div class="cora-section-wrapper {% if section.settings.design_mode %}shopify-design-mode{% endif %}">
  
  {%- for block in section.blocks -%}
    
    {%- comment -%} --- 1. SETUP VARIABLES --- {%- endcomment -%}
    {%- assign next_block = section.blocks[forloop.index] -%}
    {%- assign this_level = block.settings.level | default: 0 -%}
    {%- assign next_level = next_block.settings.level | default: 0 -%}
    
    {%- comment -%} Handle "End of Stream" by assuming next level is 0 {%- endcomment -%}
    {%- if forloop.last -%}
      {%- assign next_level = 0 -%} 
      {%- assign is_last = true -%}
    {%- endif -%}

    {%- comment -%} --- 2. RENDER THE OPENING TAG / WIDGET --- {%- endcomment -%}
    
    {%- if block.type == 'container' -%}
      <div class="cora-container cora-lvl-{{ this_level }} {% if block.settings.mobile_stack %}cora-mobile-col{% endif %}"
           style="
             flex-direction: {{ block.settings.direction }};
             justify-content: {{ block.settings.justify }};
             align-items: {{ block.settings.align }};
             flex-wrap: {{ block.settings.wrap }};
             gap: {{ block.settings.gap }}px;
             width: {{ block.settings.width }}%;
             min-height: {{ block.settings.min_height }}px;
             padding: {{ block.settings.padding }}px;
             background-color: {{ block.settings.bg_color }};
             {% if block.settings.glass %}
               backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2);
             {% endif %}
           " 
           {{ block.shopify_attributes }}>
           
           {%- if section.settings.design_mode -%}
             <span class="cora-level-tag">{{ this_level }}</span>
           {%- endif -%}

    {%- else -%}
      <div class="cora-widget" style="width: {{ block.settings.width }}%; padding: 5px;" {{ block.shopify_attributes }}>
        {%- case block.type -%}
          {%- when 'heading' -%}
            <{{ block.settings.tag }} style="margin:0; text-align:{{ block.settings.align}}; color:{{ block.settings.color }}; font-size:{{ block.settings.size }}px;">
              {{ block.settings.text }}
            </{{ block.settings.tag }}>
          
          {%- when 'text' -%}
            <div style="text-align:{{ block.settings.align}}; color:{{ block.settings.color }};">
              {{ block.settings.content }}
            </div>

          {%- when 'button' -%}
            <div style="text-align:{{ block.settings.align}};">
              <a href="{{ block.settings.link }}" class="btn" 
                 style="background: {{ block.settings.bg_color }}; color: {{ block.settings.text_color }}; padding: 12px 24px; text-decoration: none; display: inline-block;">
                 {{ block.settings.text }}
              </a>
            </div>
            
        {%- endcase -%}
      </div>
    {%- endif -%}

    {%- comment -%} 
      --- 3. THE ELEMENTOR CLOSING LOGIC --- 
      We decide how many </div> tags to print based on the NEXT block's level.
    {%- endcomment -%}

    {%- assign close_count = 0 -%}

    {%- if next_level <= this_level -%}
      {%- assign diff = this_level | minus: next_level -%}
      
      {%- if block.type == 'container' -%}
        {%- comment -%} 
           If I am a container and the next item is same/lower level, 
           I must close myself. (+1 to the difference) 
        {%- endcomment -%}
        {%- assign close_count = diff | plus: 1 -%}
      {%- else -%}
        {%- comment -%} 
           If I am a widget, I don't close myself (no div), 
           but I might close my parent containers if we are stepping down.
        {%- endcomment -%}
        {%- assign close_count = diff -%}
      {%- endif -%}
    {%- endif -%}

    {%- comment -%} Force close everything on the very last block {%- endcomment -%}
    {%- if forloop.last -%}
       {%- if block.type == 'container' -%}
         {%- assign close_count = this_level | plus: 1 -%}
       {%- else -%}
         {%- assign close_count = this_level -%}
       {%- endif -%}
    {%- endif -%}

    {%- comment -%} EXECUTE CLOSE {%- endcomment -%}
    {%- if close_count > 0 -%}
      {%- for i in (1..close_count) -%}
        </div> {%- endfor -%}
    {%- endif -%}

  {%- endfor -%}

</div>

{% schema %}
{
  "name": "Cora Elementor Engine",
  "settings": [
    { "type": "header", "content": "Engine Settings" },
    { "type": "checkbox", "id": "design_mode", "label": "ðŸ”µ Design Mode (Show Borders)", "default": true }
  ],
  "blocks": [
    {
      "type": "container",
      "name": "ðŸ“¦ Container",
      "settings": [
        { "type": "header", "content": "HIERARCHY (The Magic)" },
        { "type": "range", "id": "level", "min": 0, "max": 5, "step": 1, "label": "Nesting Level", "default": 0, "info": "0 = Section, 1 = Inside 0, 2 = Inside 1..." },

        { "type": "header", "content": "FLEXBOX LAYOUT" },
        { "type": "select", "id": "direction", "label": "Direction", "options": [
          { "value": "row", "label": "Row (Horizontal)" },
          { "value": "column", "label": "Column (Vertical)" }
        ], "default": "column" },
        { "type": "select", "id": "justify", "label": "Justify Content", "options": [
          { "value": "flex-start", "label": "Start" },
          { "value": "center", "label": "Center" },
          { "value": "flex-end", "label": "End" },
          { "value": "space-between", "label": "Space Between" }
        ], "default": "flex-start" },
        { "type": "select", "id": "align", "label": "Align Items", "options": [
          { "value": "stretch", "label": "Stretch" },
          { "value": "center", "label": "Center" },
          { "value": "flex-start", "label": "Start" },
          { "value": "flex-end", "label": "End" }
        ], "default": "stretch" },
        { "type": "range", "id": "gap", "min": 0, "max": 100, "step": 5, "label": "Gap (px)", "default": 20 },
        { "type": "select", "id": "wrap", "label": "Wrap", "options": [
          { "value": "nowrap", "label": "No Wrap" },
          { "value": "wrap", "label": "Wrap" }
        ], "default": "nowrap" },

        { "type": "header", "content": "SIZE & SPACING" },
        { "type": "range", "id": "width", "min": 10, "max": 100, "step": 5, "unit": "%", "label": "Width", "default": 100 },
        { "type": "range", "id": "min_height", "min": 0, "max": 800, "step": 50, "unit": "px", "label": "Min Height", "default": 50 },
        { "type": "range", "id": "padding", "min": 0, "max": 100, "step": 5, "label": "Padding", "default": 20 },
        
        { "type": "header", "content": "STYLE" },
        { "type": "color", "id": "bg_color", "label": "Background", "default": "transparent" },
        { "type": "checkbox", "id": "glass", "label": "Glassmorphism Effect", "default": false },
        
        { "type": "header", "content": "RESPONSIVE" },
        { "type": "checkbox", "id": "mobile_stack", "label": "Stack on Mobile (Force Column)", "default": true }
      ]
    },
    {
      "type": "heading",
      "name": "ðŸ”¤ Heading",
      "settings": [
        { "type": "range", "id": "level", "min": 1, "max": 6, "step": 1, "label": "Nesting Level", "default": 1 },
        { "type": "text", "id": "text", "label": "Text", "default": "Headline" },
        { "type": "select", "id": "tag", "label": "HTML Tag", "options": [ { "value": "h1", "label": "H1" }, { "value": "h2", "label": "H2" }, { "value": "h3", "label": "H3" } ], "default": "h2" },
        { "type": "color", "id": "color", "label": "Color", "default": "#000000" },
        { "type": "range", "id": "size", "min": 12, "max": 100, "label": "Size", "default": 32 },
        { "type": "select", "id": "align", "label": "Align", "options": [ { "value": "left", "label": "Left" }, { "value": "center", "label": "Center" }, { "value": "right", "label": "Right" } ], "default": "left" },
        { "type": "range", "id": "width", "min": 10, "max": 100, "step": 5, "unit": "%", "label": "Width", "default": 100 }
      ]
    },
    {
      "type": "text",
      "name": "ðŸ“„ Text Block",
      "settings": [
        { "type": "range", "id": "level", "min": 1, "max": 6, "step": 1, "label": "Nesting Level", "default": 1 },
        { "type": "richtext", "id": "content", "label": "Content", "default": "<p>Lorem ipsum...</p>" },
        { "type": "color", "id": "color", "label": "Color", "default": "#333333" },
        { "type": "select", "id": "align", "label": "Align", "options": [ { "value": "left", "label": "Left" }, { "value": "center", "label": "Center" }, { "value": "right", "label": "Right" } ], "default": "left" },
        { "type": "range", "id": "width", "min": 10, "max": 100, "step": 5, "unit": "%", "label": "Width", "default": 100 }
      ]
    },
    {
      "type": "button",
      "name": "ðŸ”˜ Button",
      "settings": [
        { "type": "range", "id": "level", "min": 1, "max": 6, "step": 1, "label": "Nesting Level", "default": 1 },
        { "type": "text", "id": "text", "label": "Label", "default": "Click Me" },
        { "type": "url", "id": "link", "label": "Link" },
        { "type": "color", "id": "bg_color", "label": "Background", "default": "#000000" },
        { "type": "color", "id": "text_color", "label": "Text Color", "default": "#ffffff" },
        { "type": "select", "id": "align", "label": "Align", "options": [ { "value": "left", "label": "Left" }, { "value": "center", "label": "Center" }, { "value": "right", "label": "Right" } ], "default": "left" },
        { "type": "range", "id": "width", "min": 10, "max": 100, "step": 5, "unit": "%", "label": "Width", "default": 100 }
      ]
    }
  ],
  "presets": [{ "name": "Cora Elementor Engine" }]
}
{% endschema %}